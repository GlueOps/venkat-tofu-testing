name: terraform Workflow

on:
  issue_comment:
    types: [created]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  terraform-action:
    if: >-
      contains(github.event.comment.body, 'terraform plan') ||
      contains(github.event.comment.body, 'terraform apply') ||
      contains(github.event.comment.body, 'terraform yolo')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Extract Command and Directory
      id: extract
      run: |
        COMMENT="${{ github.event.comment.body }}"
        if [[ "$COMMENT" =~ terraform\ plan\ (.+) ]]; then
          echo "COMMAND=plan" >> $GITHUB_ENV
          DIRECTORY="${BASH_REMATCH[1]}"
        elif [[ "$COMMENT" =~ terraform\ apply\ (.+) ]]; then
          echo "COMMAND=apply" >> $GITHUB_ENV
          DIRECTORY="${BASH_REMATCH[1]}"
        elif [[ "$COMMENT" =~ terraform\ yolo\ (.+) ]]; then
          echo "COMMAND=yolo" >> $GITHUB_ENV
          DIRECTORY="${BASH_REMATCH[1]}"
        fi
        echo "DIRECTORY=$DIRECTORY" >> $GITHUB_ENV


    - name: terraform plan
      if: env.COMMAND == 'plan'
      uses: dflook/terraform-plan@v1
      with:
        path: ${{ env.DIRECTORY }}

    - name: terraform apply
      if: env.COMMAND == 'apply'
      uses: dflook/terraform-apply@v1
      with:
        path: ${{ env.DIRECTORY }}
